<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìˆœìœ„ ì˜ˆì¸¡ - Pitwall</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <!-- ğŸ“Š Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ğŸ“Š Chart.js ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ (ì ìˆ˜ í‘œì‹œìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
      .prediction-hero {
        text-align: center;
        padding: 3rem 1rem;
        background: linear-gradient(
            rgba(10, 25, 47, 0.8),
            rgba(10, 25, 47, 0.9)
          ),
          url("https://media.formula1.com/image/upload/f_auto/q_auto/v1677244985/content/dam/fom-website/manual/Misc/2023-Season-Guide/2023-Season-Guide-Header.jpg.transform/9col/image.jpg");
        background-size: cover;
        background-position: center;
        border-radius: 12px;
        margin-bottom: 2rem;
        border: 1px solid #2a3f5a;
      }

      .prediction-form-container {
        background-color: var(--secondary-bg);
        padding: 2rem;
        border-radius: 12px;
        max-width: 800px;
        margin: 0 auto 3rem auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .race-selector {
        width: 100%;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 8px;
        border: 1px solid var(--accent-color);
        background-color: #0a192f;
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
      }

      .podium-inputs {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
      }

      .podium-input {
        text-align: center;
        flex: 1;
        min-width: 200px;
      }

      .podium-input label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: var(--accent-color);
      }

      .podium-select {
        width: 100%;
        padding: 0.8rem;
        border-radius: 8px;
        border: 1px solid #2a3f5a;
        background-color: #0a192f;
        color: white;
        text-align: center;
        font-size: 1rem;
        cursor: pointer;
      }

      .podium-select:disabled {
        background-color: #2a3f5a;
        color: #8892b0;
        cursor: not-allowed;
        border-color: #444;
      }

      .submit-pred-btn {
        background-color: var(--accent-color);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        transition: background 0.3s;
      }
      .submit-pred-btn:hover {
        background-color: #e03e00;
      }
      .submit-pred-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
      }

      .chart-container {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #2a3f5a;
      }
      .chart-container h3 {
        text-align: center;
        color: var(--text-color);
        margin-bottom: 1rem;
      }

      /* ëŒ“ê¸€ ì˜ì—­ ìŠ¤íƒ€ì¼ */
      .prediction-comments {
        max-width: 800px;
        margin: 0 auto 3rem auto;
        background-color: var(--secondary-bg);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .comment-header {
        border-bottom: 1px solid #2a3f5a;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: var(--accent-color);
      }

      .comment-list {
        list-style: none;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 1.5rem;
      }

      .comment-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1rem 0;
      }
      .comment-meta {
        font-size: 0.85rem;
        color: #8892b0;
        margin-bottom: 5px;
      }
      .comment-meta strong {
        color: white;
        margin-right: 8px;
      }
      .comment-content {
        color: #e0e0e0;
        line-height: 1.5;
      }

      .comment-form {
        display: flex;
        gap: 10px;
      }
      .comment-input {
        flex: 1;
        height: 50px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #2a3f5a;
        background: #0a192f;
        color: white;
        resize: none;
      }
      .comment-submit-btn {
        background-color: var(--accent-color);
        color: white;
        border: none;
        padding: 0 1.5rem;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
      }
      .comment-submit-btn:hover {
        background-color: #e03e00;
      }

      .comment-list::-webkit-scrollbar {
        width: 8px;
      }
      .comment-list::-webkit-scrollbar-thumb {
        background: #2a3f5a;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo"><a href="index.html">Pitwall</a></div>
      <nav>
        <ul>
          <li><a href="pickteam.html">ì‘ì› íŒ€ ì¶”ì²œ</a></li>
          <li><a href="news.html">ìµœì‹  ë‰´ìŠ¤</a></li>
          <li><a href="schedule.html">ê²½ê¸° ì¼ì •</a></li>
          <li>
            <!-- ğŸ‘‡ ì»¤ë®¤ë‹ˆí‹° ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
            <a href="board.html">ì»¤ë®¤ë‹ˆí‹° â–¾</a>
            <ul class="dropdown-content">
              <li><a href="board.html">ììœ ê²Œì‹œíŒ</a></li>
              <li><a href="prediction.html">ìˆœìœ„ ì˜ˆì¸¡</a></li>
            </ul>
          </li>

          <li>
            <a href="glossary.html">F1 ì •ë³´ â–¾</a>
            <ul class="dropdown-content">
              <li><a href="glossary.html">F1ìš©ì–´ì‚¬ì „</a></li>
              <li><a href="driver.html">ë“œë¼ì´ë²„</a></li>
              <li><a href="constructor.html">íŒ€</a></li>
              <li><a href="circuit.html">ì„œí‚·</a></li>
            </ul>
          </li>

          <li>
            <a href="">Shop â–¾</a>
            <ul class="dropdown-content">
              <li><a href="https://f1store.formula1.com/en/">F1 store</a></li>
              <li><a href="https://www.fuelforfans.com/">Fuel for Fans</a></li>
            </ul>
          </li>
        </ul>
      </nav>

      <div class="user-actions">
        <div id="logged-out-view">
          <a href="login.html" class="btn">ë¡œê·¸ì¸</a>
          <a href="signup.html" class="btn btn-accent">íšŒì›ê°€ì…</a>
        </div>
        <div id="logged-in-view" style="display: none">
          <span id="user-nickname" class="nickname-display"></span>
          <a href="my-info.html" class="btn">ë‚´ ì •ë³´ ê´€ë¦¬</a>
          <a href="#" id="logout-button" class="btn">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
      </div>
    </header>

    <main>
      <section class="prediction-hero">
        <h1>ğŸ† F1 ê·¸ë‘í”„ë¦¬ ìˆœìœ„ ì˜ˆì¸¡</h1>
        <p>ì´ë²ˆ ê²½ê¸°ì˜ ìš°ìŠ¹ìëŠ” ëˆ„ê°€ ë ê¹Œìš”? (1ìœ„ 3ì , 2ìœ„ 2ì , 3ìœ„ 1ì )</p>
      </section>

      <div class="prediction-form-container">
        <label
          for="race-select"
          style="display: block; margin-bottom: 0.5rem; color: #8892b0"
          >ì˜ˆì¸¡í•  ê²½ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”:</label
        >
        <select id="race-select" class="race-selector">
          <option value="" disabled selected>ê²½ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        </select>

        <form id="prediction-form">
          <div class="podium-inputs">
            <div class="podium-input">
              <label>ğŸ¥‡ 1ìœ„ (Winner)</label>
              <select id="pred-1st" class="podium-select" required>
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
              </select>
            </div>
            <div class="podium-input">
              <label>ğŸ¥ˆ 2ìœ„ (2nd)</label>
              <select id="pred-2nd" class="podium-select" required>
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
              </select>
            </div>
            <div class="podium-input">
              <label>ğŸ¥‰ 3ìœ„ (3rd)</label>
              <select id="pred-3rd" class="podium-select" required>
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
              </select>
            </div>
          </div>
          <button type="submit" id="submit-btn" class="submit-pred-btn">
            ì˜ˆì¸¡ ì œì¶œí•˜ê¸°
          </button>
        </form>

        <div class="chart-container" style="display: none" id="stats-section">
          <h3>
            ğŸ“Š íŒ¬ë“¤ì´ ì˜ˆìƒí•œ <span id="chart-title">ê²½ê¸°</span> ë“œë¼ì´ë²„ ìˆœìœ„
            (Top 5)
          </h3>
          <canvas id="predictionChart"></canvas>
        </div>
      </div>

      <!-- ëŒ“ê¸€ ì˜ì—­ -->
      <div
        class="prediction-comments"
        id="comment-section"
        style="display: none"
      >
        <h3 class="comment-header">
          ğŸ <span id="comment-race-title"></span> ì‘ì› ë° ì˜ˆì¸¡ í† ë¡ 
        </h3>
        <ul id="pred-comment-list" class="comment-list"></ul>
        <form id="pred-comment-form" class="comment-form">
          <textarea
            id="pred-comment-input"
            class="comment-input"
            placeholder="ë¡œê·¸ì¸ í›„ ì˜ê²¬ì„ ë‚¨ê²¨ë³´ì„¸ìš”..."
            required
          ></textarea>
          <button type="submit" class="comment-submit-btn">ë“±ë¡</button>
        </form>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 Pitwall. All rights reserved.</p>
    </footer>

    <script src="schedule-data.js"></script>
    <script src="driver-data.js"></script>
    <script src="script.js"></script>

    <script>
      // í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
      Chart.register(ChartDataLabels);

      document.addEventListener("DOMContentLoaded", async () => {
        const raceSelect = document.getElementById("race-select");
        const pred1st = document.getElementById("pred-1st");
        const pred2nd = document.getElementById("pred-2nd");
        const pred3rd = document.getElementById("pred-3rd");
        const submitBtn = document.getElementById("submit-btn");

        const statsSection = document.getElementById("stats-section");
        const chartTitle = document.getElementById("chart-title");

        // ëŒ“ê¸€ ê´€ë ¨
        const commentSection = document.getElementById("comment-section");
        const commentRaceTitle = document.getElementById("comment-race-title");
        const commentList = document.getElementById("pred-comment-list");
        const commentForm = document.getElementById("pred-comment-form");
        const commentInput = document.getElementById("pred-comment-input");

        let myChart = null;
        let myPredictions = {};

        // 0. ë‚´ ì˜ˆì¸¡ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchMyPredictions() {
          const token = sessionStorage.getItem("token");
          if (!token) return;

          try {
            const res = await fetch("http://localhost:3001/api/predictions", {
              headers: { Authorization: `Bearer ${token}` },
            });
            const data = await res.json();
            data.forEach((p) => {
              myPredictions[p.round] = p;
            });
          } catch (err) {
            console.error(err);
          }
        }
        await fetchMyPredictions();

        // 1. ê²½ê¸° ëª©ë¡
        if (typeof scheduleData !== "undefined") {
          scheduleData.forEach((gp) => {
            const option = document.createElement("option");
            option.value = gp.round;
            option.textContent = `Round ${gp.round} - ${gp.gpName}`;
            raceSelect.appendChild(option);
          });
        }

        // 2. ë“œë¼ì´ë²„ ëª©ë¡
        const fillDrivers = (selectElement) => {
          if (typeof driverData !== "undefined") {
            driverData.forEach((d) => {
              const option = document.createElement("option");
              option.value = d.name;
              option.textContent = `${d.name} (${d.nameKr})`;
              selectElement.appendChild(option);
            });
          }
        };
        fillDrivers(pred1st);
        fillDrivers(pred2nd);
        fillDrivers(pred3rd);

        // 3. ê²½ê¸° ì„ íƒ ì‹œ
        raceSelect.addEventListener("change", (e) => {
          const round = e.target.value;
          const raceName = e.target.options[e.target.selectedIndex].text;

          chartTitle.textContent = raceName;
          commentRaceTitle.textContent = raceName;

          if (myPredictions[round]) {
            const saved = myPredictions[round];
            pred1st.value = saved.first_place;
            pred2nd.value = saved.second_place;
            pred3rd.value = saved.third_place;
            pred1st.disabled = true;
            pred2nd.disabled = true;
            pred3rd.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = "ì œì¶œ ì™„ë£Œ (ìˆ˜ì • ë¶ˆê°€)";
          } else {
            pred1st.value = "";
            pred2nd.value = "";
            pred3rd.value = "";
            pred1st.disabled = false;
            pred2nd.disabled = false;
            pred3rd.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = "ì˜ˆì¸¡ ì œì¶œí•˜ê¸°";
          }

          loadStats(round);
          loadComments(round);
        });

        // 4. ì˜ˆì¸¡ ì œì¶œ
        document
          .getElementById("prediction-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const token = sessionStorage.getItem("token");
            if (!token) {
              alert("ë¡œê·¸ì¸ í•„ìš”");
              location.href = "login.html";
              return;
            }

            const round = raceSelect.value;
            if (!round) return alert("ê²½ê¸° ì„ íƒ í•„ìš”");

            const p1 = pred1st.value;
            const p2 = pred2nd.value;
            const p3 = pred3rd.value;
            if (p1 === p2 || p1 === p3 || p2 === p3)
              return alert("1,2,3ìœ„ ì„ ìˆ˜ëŠ” ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.");
            if (!confirm("ì œì¶œ í›„ ìˆ˜ì • ë¶ˆê°€í•©ë‹ˆë‹¤. ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
              const response = await fetch(
                "http://localhost:3001/api/predictions",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({
                    round,
                    first_place: p1,
                    second_place: p2,
                    third_place: p3,
                  }),
                }
              );

              if (response.ok) {
                alert("ì œì¶œ ì™„ë£Œ!");
                myPredictions[round] = {
                  first_place: p1,
                  second_place: p2,
                  third_place: p3,
                };
                pred1st.disabled = true;
                pred2nd.disabled = true;
                pred3rd.disabled = true;
                submitBtn.disabled = true;
                submitBtn.textContent = "ì œì¶œ ì™„ë£Œ";
                loadStats(round);
              } else {
                const err = await response.json();
                alert(err.message);
              }
            } catch (error) {
              console.error(error);
            }
          });

        // 5. ëŒ“ê¸€ ì‘ì„±
        commentForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const token = sessionStorage.getItem("token");
          if (!token) {
            alert("ë¡œê·¸ì¸ í•„ìš”");
            return;
          }

          const round = raceSelect.value;
          const content = commentInput.value;

          try {
            const res = await fetch(
              `http://localhost:3001/api/predictions/${round}/comments`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ content }),
              }
            );
            if (res.ok) {
              commentInput.value = "";
              loadComments(round);
            } else {
              alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
            }
          } catch (err) {
            console.error(err);
          }
        });

        async function loadComments(round) {
          try {
            const res = await fetch(
              `http://localhost:3001/api/predictions/${round}/comments`
            );
            const comments = await res.json();
            commentSection.style.display = "block";
            commentList.innerHTML = "";
            if (comments.length === 0) {
              commentList.innerHTML =
                '<li style="text-align:center; color:#8892b0; padding:1rem;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</li>';
              return;
            }
            comments.forEach((cmt) => {
              const li = document.createElement("li");
              li.className = "comment-item";
              li.innerHTML = `
                            <div class="comment-meta">
                                <strong>${
                                  cmt.nickname
                                }</strong><span>${new Date(
                cmt.created_at
              ).toLocaleString()}</span>
                            </div>
                            <div class="comment-content">${cmt.content}</div>
                        `;
              commentList.appendChild(li);
            });
          } catch (err) {
            console.error(err);
          }
        }

        // 6. ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ì ìˆ˜ ê³„ì‚° + ìƒ‰ìƒ + ë¼ë²¨)
        async function loadStats(round) {
          try {
            const res = await fetch(
              `http://localhost:3001/api/predictions/stats?round=${round}`
            );
            const data = await res.json(); // ì„œë²„ì—ì„œ ì´ë¯¸ ì ìˆ˜ í•©ì‚°ëœ ë°ì´í„° ì˜´

            statsSection.style.display = "block";
            const top5Data = data.slice(0, 5);

            // ìˆœìœ„ë³„ ìƒ‰ìƒ
            const rankColors = {
              1: "rgba(255, 215, 0, 0.8)",
              2: "rgba(192, 192, 192, 0.8)",
              3: "rgba(205, 127, 50, 0.8)",
              4: "rgba(255, 69, 0, 0.6)",
              5: "rgba(255, 69, 0, 0.4)",
            };

            // ìˆœìœ„ ê³„ì‚° (ë™ì ì ì²˜ë¦¬)
            let rank = 0;
            let prevScore = -1; // ë“í‘œìˆ˜ ëŒ€ì‹  ì ìˆ˜(score)ë¡œ ë¹„êµ
            const rankedData = top5Data.map((item, index) => {
              // ì„œë²„ì—ì„œ scoreë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë³´ë‚´ì£¼ë¯€ë¡œ item.score ì‚¬ìš©
              if (item.score !== prevScore) rank = index + 1;
              prevScore = item.score;
              return { ...item, rank };
            });

            const rankCounts = {};
            rankedData.forEach((item) => {
              rankCounts[item.rank] = (rankCounts[item.rank] || 0) + 1;
            });

            const labels = [];
            const backgroundColors = [];

            rankedData.forEach((item) => {
              const prefix = rankCounts[item.rank] > 1 ? "ê³µë™ " : "";
              labels.push(`${prefix}${item.rank}ìœ„ ${item.driver}`);
              backgroundColors.push(
                rankColors[item.rank] || "rgba(255, 255, 255, 0.3)"
              );
            });

            // ê°’ì€ ì ìˆ˜(score)
            const scores = rankedData.map((item) => item.score);
            const ctx = document
              .getElementById("predictionChart")
              .getContext("2d");

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "ì˜ˆì¸¡ ì ìˆ˜ í•©ê³„",
                    data: scores,
                    backgroundColor: backgroundColors,
                    borderColor: "rgba(255, 255, 255, 0.5)",
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { display: false },
                    grid: { display: false },
                  },
                  x: { ticks: { color: "white" }, grid: { display: false } },
                },
                plugins: {
                  legend: { display: false },
                  datalabels: {
                    color: "white",
                    font: { weight: "bold", size: 14 },
                    // ğŸ“ ê·¸ë˜í”„ ì¤‘ì•™ ë¼ë²¨ í¬ë§· (ì ìˆ˜ í‘œì‹œ)
                    formatter: (value) => value + "ì ",
                    anchor: "center",
                    align: "center",
                  },
                },
              },
              plugins: [ChartDataLabels],
            });
          } catch (err) {
            console.error(err);
          }
        }
      });
    </script>
  </body>
</html>
